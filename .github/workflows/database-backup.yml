name: Supabase Database Backup

on:
  # Automated daily schedule at 3:00 AM Chile Time (UTC-3 = 6:00 AM UTC)
  schedule:
    - cron: '0 6 * * *'  # Runs at 06:00 UTC = 3:00 AM Chile Time

  # Allow manual triggering from GitHub UI
  workflow_dispatch:
    inputs:
      backup_type:
        description: 'Type of backup to perform'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - schema-only
          - data-only

jobs:
  backup-database:
    runs-on: ubuntu-latest

    # Set timeout to prevent hanging workflows
    timeout-minutes: 30

    # Add permissions for the GITHUB_TOKEN
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create backup directory
        id: backup-info
        run: |
          BACKUP_DIR="backups/$(date +%Y-%m-%d)"
          BACKUP_DATE="$(date +%Y-%m-%d)"
          BACKUP_TIMESTAMP="$(date +%Y-%m-%d_%H-%M-%S)"
          mkdir -p "$BACKUP_DIR"
          echo "BACKUP_DIR=$BACKUP_DIR" >> $GITHUB_OUTPUT
          echo "BACKUP_DATE=$BACKUP_DATE" >> $GITHUB_OUTPUT
          echo "BACKUP_TIMESTAMP=$BACKUP_TIMESTAMP" >> $GITHUB_OUTPUT

      - name: Install PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Backup Database Schema and Data
        env:
          PGPASSWORD: Chucrut1400#
        run: |
          pg_dump \
            -h db.rurggkctnsrvwodcpuvt.supabase.co \
            -p 5432 \
            -U postgres \
            -d postgres \
            --schema=public \
            --no-owner \
            --no-acl \
            -f "${{ steps.backup-info.outputs.BACKUP_DIR }}/full_backup.sql"

          # Create schema-only backup
          pg_dump \
            -h db.rurggkctnsrvwodcpuvt.supabase.co \
            -p 5432 \
            -U postgres \
            -d postgres \
            --schema=public \
            --schema-only \
            --no-owner \
            --no-acl \
            -f "${{ steps.backup-info.outputs.BACKUP_DIR }}/schema.sql"

          # Create data-only backup
          pg_dump \
            -h db.rurggkctnsrvwodcpuvt.supabase.co \
            -p 5432 \
            -U postgres \
            -d postgres \
            --schema=public \
            --data-only \
            --no-owner \
            --no-acl \
            -f "${{ steps.backup-info.outputs.BACKUP_DIR }}/data.sql"

      - name: Create backup metadata
        run: |
          cat > "${{ steps.backup-info.outputs.BACKUP_DIR }}/backup-info.json" <<EOF
          {
            "backup_date": "${{ steps.backup-info.outputs.BACKUP_DATE }}",
            "backup_timestamp": "${{ steps.backup-info.outputs.BACKUP_TIMESTAMP }}",
            "database_url": "https://rurggkctnsrvwodcpuvt.supabase.co",
            "workflow_run_id": "${{ github.run_id }}",
            "workflow_run_number": "${{ github.run_number }}",
            "triggered_by": "${{ github.event_name }}",
            "actor": "${{ github.actor }}",
            "backup_type": "${{ github.event.inputs.backup_type || 'full' }}",
            "tables": [
              "profiles",
              "solicitudes",
              "clients",
              "technicians",
              "working_hours",
              "bookings",
              "time_off",
              "services",
              "comentarios",
              "notifications"
            ]
          }
          EOF

      - name: Create README for backup
        run: |
          cat > "${{ steps.backup-info.outputs.BACKUP_DIR }}/README.md" <<'EOF'
          # Database Backup - ${{ steps.backup-info.outputs.BACKUP_DATE }}

          ## Backup Information
          - **Date:** ${{ steps.backup-info.outputs.BACKUP_TIMESTAMP }}
          - **Database:** rurggkctnsrvwodcpuvt.supabase.co
          - **Triggered by:** ${{ github.event_name }}
          - **Workflow Run:** [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ## Files Included
          - `full_backup.sql` - Complete database backup (schema + data)
          - `schema.sql` - Table structures, indexes, constraints, RLS policies, triggers, functions
          - `data.sql` - All table data
          - `backup-info.json` - Metadata about this backup

          ## How to Restore

          See the main [RESTORE.md](../../RESTORE.md) guide in the backups directory.

          ### Quick Restore - Full Database
          ```bash
          psql -h db.rurggkctnsrvwodcpuvt.supabase.co -p 5432 -U postgres -d postgres -f full_backup.sql
          ```

          ### Restore Schema and Data Separately
          ```bash
          psql -h db.rurggkctnsrvwodcpuvt.supabase.co -p 5432 -U postgres -d postgres -f schema.sql
          psql -h db.rurggkctnsrvwodcpuvt.supabase.co -p 5432 -U postgres -d postgres -f data.sql
          ```

          ## Tables Backed Up
          - profiles
          - solicitudes
          - clients
          - technicians
          - working_hours
          - bookings
          - time_off
          - services
          - comentarios
          - notifications
          EOF

      - name: Compress backup files
        run: |
          cd backups
          tar -czf "${{ steps.backup-info.outputs.BACKUP_DATE }}.tar.gz" "${{ steps.backup-info.outputs.BACKUP_DATE }}"
          echo "Backup compressed: $(ls -lh ${{ steps.backup-info.outputs.BACKUP_DATE }}.tar.gz)"

      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Commit backup files
        run: |
          git add backups/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: automated database backup - ${{ steps.backup-info.outputs.BACKUP_TIMESTAMP }}

            Backup details:
            - Date: ${{ steps.backup-info.outputs.BACKUP_DATE }}
            - Timestamp: ${{ steps.backup-info.outputs.BACKUP_TIMESTAMP }}
            - Triggered by: ${{ github.event_name }}
            - Files: full_backup.sql, schema.sql, data.sql
            - Tables: profiles, solicitudes, clients, technicians, working_hours, bookings, time_off, services, comentarios, notifications

            ðŸ¤– Automated backup via GitHub Actions
            Workflow: ${{ github.workflow }}
            Run: ${{ github.run_number }}"
            git push
          fi

      - name: Cleanup old backups (keep last 30 days)
        run: |
          # Find and remove backup directories older than 30 days
          find backups -type d -name "20*" -mtime +30 -exec rm -rf {} + 2>/dev/null || true
          # Find and remove compressed backups older than 30 days
          find backups -type f -name "*.tar.gz" -mtime +30 -delete 2>/dev/null || true

          # Commit cleanup if there were changes
          git add backups/
          if ! git diff --staged --quiet; then
            git commit -m "chore: cleanup backups older than 30 days"
            git push
          fi

      - name: Upload backup artifacts
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ steps.backup-info.outputs.BACKUP_DATE }}
          path: backups/${{ steps.backup-info.outputs.BACKUP_DATE }}.tar.gz
          retention-days: 90

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Database backup failed!"
          echo "Backup Date: ${{ steps.backup-info.outputs.BACKUP_DATE }}"
          echo "Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
